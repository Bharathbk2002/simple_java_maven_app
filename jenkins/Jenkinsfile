pipeline {
    agent {
  label 'devServer'
}
    tools {
  maven 'my-maven'
}
    environment {
        Name = "Bharath"
    }
    parameters {
  choice choices: ['dev', 'prod'], name: 'select_environment'
    }
    
    stages {
        stage('build') {
            steps {
                sh 'mvn clean package -DskipTests=true'
                echo "hello ${Name} ${params.lastname}"
                stash name: 'buildArtifacts', includes: '**/target/*.jar'
            }
        }

        stage('test') {
            parallel {
                stage('testA') {
                    agent {label 'devServer'}
                    steps {
                        echo "This is test A"
                        sh 'mvn test'
                    }
                }
                stage('testB') {
                    agent {label 'devServer'}
                    steps {
                        echo "This is test B"
                        sh 'mvn test'
                    }
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: '**/target/*.jar'
                }
            }
        }

        stage('deploy_dev') {
            when{expression{params.select_environment=='dev'}beforeAgent=true}
            agent 
            {
                    label 'devServer'
            }
            steps {
                unstash 'buildArtifacts'
                echo "Deploying the application..."
                sh 'java -jar $WORKSPACE/target/my-app-1.0-SNAPSHOT.jar'
            }
        }
    }
}
